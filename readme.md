# Сервис динамического сегментирования пользователей

## Описание:
Тестовое задание для стажировки Авито.\
Текст задания можно посмотреть [тут](https://github.com/avito-tech/backend-trainee-assignment-2023#readme).\
Приложение представляет собой API сервис, который включает:
- Добавление/удаление/просмотр списка пользователей
- Добавление/удаление сегментов
- Просмотр всем сегментов пользователя и список всех назначенных сегментов всем пользователям
- Добавление/удаление сегментов пользователям
- Запрос CSV-отчёта по действиям с сегментами пользователей

## Запуск приложения:

1. Загрузить [проект](https://github.com/ezulex/go-test-avito) на локальную машину
2. Выполнить в каталоге проекта команду `docker compose up --build` для билда приложения и создания контейнеров docker (приложение, база)

## Примеры запросов:

### Получение сегментов пользователя (на примере Postman)

**Запрос**: GET localhost:8000/user-segments/2\
**Ответ**: \
`{`\
`"user-id": 2,`\
`"segment-names": "AVITO_002"`\
`}`

### Добавление сегмента (на примере Postman)

**Запрос**: POST localhost:8000/segments

**Тело запроса**:\
`{`\
`"name": "AVITO_TEST"`\
`}`

**Ответ**: \
`{`\
`"status": "success",`\
`"message": "Segment 'AVITO_TEST' was added"`\
`}`

### Добавление/удаление сегментов пользователя (на примере Postman)

**Запрос**: POST localhost:8000/user-segments

**Тело запроса**:\
`{`\
`"user-id": 2,`\
`"segments": ["AVITO_TEST"],`\
`"segments-for-delete": ["AVITO_PHONE"]`\
`}`

**Ответ**: \
`[{`\
`"status": "success",`\
`"message": "Segment 'AVITO_TEST' for user '2' was added"`\
`},`\
`{`\
`"status": "error",`\
`"message": "Segment 'AVITO_PHONE' does not exist!"`\
`}]`

Документацию по всем запросам можно посмотреть в Swagger, для этого:
1. Скачать [Swagger-файл](https://github.com/ezulex/go-test-avito/blob/master/swaggerApi.yaml)
2. Ввести содержимое в https://editor.swagger.io

### Комментарии:
1. Код не защищён от SQL-инъекций. 
Для защиты можно, например, использовать проверку данных на входе или использовать ORM для работы с базой.
3. Не уверен в корректности ответов API и соответствии общепринятым стандартам. 
Предполагаю, что возвращать данные можно в более "правильном" формате.
Например, в методе `POST /user-segments` передаём в запросе список сегментов для добавления и удаления 
и в ответе возвращается результат выполнения каждого действия. 
В таком случае не всегда понятно какой код ответа API. Думаю, что есть более простая структура ответа.
4. В первом дополнительном задании получаю период и формирую csv файл с отчётом в контейнере. 
Разобраться с частью, где возвращаю этот отчёт в API в виде ссылки, к сожалению, не успел.
5. Использовал базу PostrgeSQL, в которой нет встроенного TTL. 
Была идея решить второе дополнительное задание с помощью триггера, но это не решило бы задачу автоматического удаления,
потому что триггер запустится только по какому-нибудь действию, например, при добавлении нового сегмента.
Считаю подходящим решением отдельную таску, которая запускается по крону. 
6. Аналогично второму, в третьем дополнительном задании можно "раскидывать" сегменты при создании нового сегмента на процент пользователей, 
но это не решит задачу, если мы добавим/удалим новых пользователей. 
Либо, можно сильно усложнять логику и при создании/удалении пользователя проверять настройки сегментов и считать, 
нужно ли пользователю добавлять/удалять сегмент или нет.
Вариант с задачей по крону вижу как более простой.


